<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Riffle - Music Quiz</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet"/>
  <style>
    body { font-family: 'Montserrat', sans-serif; }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    .pulse-animation {
      animation: pulse 2s infinite;
    }
    
    .progress-bar {
      transition: width 0.1s linear;
    }
    
    .answer-btn:hover:not(.selected) {
      transform: translateY(-2px);
    }
    
    .answer-btn.selected {
      transform: translateY(1px);
    }
    
    .answer-btn.correct {
      background: rgba(16, 185, 129, 0.9) !important;
      box-shadow: 0 0 20px rgba(16, 185, 129, 0.7);
    }
    
    .answer-btn.wrong {
      background: rgba(239, 68, 68, 0.9) !important;
      box-shadow: 0 0 20px rgba(239, 68, 68, 0.7);
    }
    
    .confetti {
      position: absolute;
      width: 10px;
      height: 10px;
      background-color: #f00;
      border-radius: 0;
    }
    
    @keyframes fadeAndMove {
      0% { transform: translateY(0) rotate(0); opacity: 1; }
      100% { transform: translateY(-100px) rotate(360deg); opacity: 0; }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-gray-900 via-purple-900 to-black min-h-screen text-white overflow-hidden">
  <!-- Game Loading Screen -->
  <div id="loading-screen" class="fixed inset-0 flex items-center justify-center bg-black z-50">
    <div class="text-center">
      <h2 class="text-5xl font-extrabold mb-8 text-purple-400 tracking-wider">RIFFLE</h2>
      <div class="w-64 h-2 bg-gray-800 rounded-full mx-auto overflow-hidden">
        <div id="loading-progress" class="h-full bg-gradient-to-r from-purple-500 to-indigo-600 rounded-full" style="width: 0%"></div>
      </div>
      <p class="mt-4 text-purple-300" id="loading-text">Loading music tracks...</p>
    </div>
  </div>

  <!-- Top Navigation -->
  <nav class="relative z-10 px-4 pt-4 flex justify-between items-center">
    <button id="mainMenuBtn" type="button" class="flex items-center text-white hover:text-purple-300 transition bg-black bg-opacity-60 border border-purple-600 rounded-lg px-3 py-2 shadow-lg hover:scale-105 transform transition-all duration-300 cursor-pointer z-[1000]">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 17l-5-5m0 0l5-5m-5 5h12" />
      </svg>
      Main Menu
    </button>
    <div class="text-white text-xl font-bold flex items-center">
      <span id="game-mode-title">Marathon Mode</span>
      <span id="round-info" class="ml-4 text-sm bg-purple-800 px-3 py-1 rounded-full">Question 1/10</span>
    </div>
  </nav>

  <!-- Game Container -->
  <main class="relative z-10 flex flex-col items-center justify-center min-h-[80vh] px-4 py-8">
    <!-- Audio Player (Hidden) -->
    <audio id="music-player" class="hidden"></audio>

    <!-- Score Display -->
    <div class="absolute top-6 right-6 flex items-center">
      <div class="bg-black bg-opacity-50 px-4 py-2 rounded-lg flex items-center">
        <!-- Player Avatar -->
        <div class="h-8 w-8 rounded-full bg-gradient-to-br from-purple-500 to-indigo-600 p-1 mr-3 flex-shrink-0">
          <img id="player-avatar" src="src/img/avatars/avatar1.png" alt="Player Avatar" class="rounded-full">
        </div>
        
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-400 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
        </svg>
        <span id="current-score" class="text-xl font-bold">0</span>
        <span class="mx-1">/</span>
        <span id="max-score">10</span>
        
        <!-- Lives display for Marathon mode -->
        <div id="lives-display" class="ml-4 hidden">
          <div class="flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500 mr-1" fill="currentColor" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
            </svg>
            <span id="lives-count" class="text-md font-bold text-red-400">3</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Timer Bar (For VS modes) -->
    <div id="timer-container" class="w-full max-w-3xl mb-6">
      <div class="w-full h-3 bg-gray-800 rounded-full overflow-hidden">
        <div id="timer-bar" class="h-full bg-gradient-to-r from-red-500 to-yellow-500 progress-bar" style="width: 100%"></div>
      </div>
    </div>

    <!-- Album Art & Visualizer -->
    <div class="mb-10 relative">
      <div class="w-48 h-48 md:w-64 md:h-64 rounded-full bg-gradient-to-r from-purple-600 to-indigo-600 flex items-center justify-center pulse-animation">
        <div class="w-24 h-24 md:w-32 md:h-32 rounded-full bg-black flex items-center justify-center">
          <svg id="play-icon" xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-white" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
          </svg>
          <svg id="pause-icon" xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-white hidden" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
          </svg>
        </div>
      </div>
      
      <!-- Audio Visualizer Bars -->
      <div id="visualizer" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full h-full flex items-center justify-center -z-10">
        <!-- Visualizer bars will be created dynamically -->
      </div>
    </div>

    <!-- Question -->
    <div class="text-center mb-8">
      <h2 id="question-text" class="text-3xl md:text-4xl font-bold mb-2 text-white">Which song is this track from?</h2>
      <p id="genre-info" class="text-lg text-purple-300">70's Rock</p>
    </div>

    <!-- Answer Options -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full max-w-3xl">
      <button class="answer-btn bg-purple-900 bg-opacity-50 hover:bg-opacity-70 py-4 px-6 rounded-xl text-xl font-semibold transition duration-200 transform shadow-lg">Answer 1</button>
      <button class="answer-btn bg-purple-900 bg-opacity-50 hover:bg-opacity-70 py-4 px-6 rounded-xl text-xl font-semibold transition duration-200 transform shadow-lg">Answer 2</button>
      <button class="answer-btn bg-purple-900 bg-opacity-50 hover:bg-opacity-70 py-4 px-6 rounded-xl text-xl font-semibold transition duration-200 transform shadow-lg">Answer 3</button>
      <button class="answer-btn bg-purple-900 bg-opacity-50 hover:bg-opacity-70 py-4 px-6 rounded-xl text-xl font-semibold transition duration-200 transform shadow-lg">Answer 4</button>
    </div>

    <!-- Players (For multiplayer modes) -->
    <div id="players-container" class="w-full max-w-3xl mt-10 hidden">
      <h3 class="text-xl font-bold mb-3 text-purple-300">Players</h3>
      <div class="bg-black bg-opacity-50 rounded-xl p-4">
        <div id="players-list" class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <!-- Player cards will be generated dynamically -->
        </div>
      </div>
    </div>
  </main>

  <!-- Round Completion Screen (Hidden by default) -->
  <div id="round-completion" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 hidden">
    <div class="bg-gradient-to-br from-purple-900 to-indigo-900 rounded-2xl p-8 max-w-2xl w-full mx-4 relative shadow-2xl transform transition-all duration-500 scale-100">
      <div class="absolute -top-16 left-1/2 transform -translate-x-1/2 bg-gradient-to-r from-yellow-500 to-yellow-300 rounded-full p-4 shadow-lg">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-purple-900" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      </div>
      
      <h2 class="text-3xl font-extrabold mb-2 text-center text-white mt-8">Round Complete!</h2>
      
      <!-- Album cover display -->
      <div class="mb-4 flex justify-center">
        <div class="w-32 h-32 md:w-40 md:h-40 rounded-lg overflow-hidden shadow-lg">
          <img id="album-cover-display" src="https://via.placeholder.com/200" alt="Album Cover" class="w-full h-full object-cover">
        </div>
      </div>
      
      <div class="mb-4 text-center">
        <div id="round-result" class="text-4xl font-bold text-yellow-400 mb-2">Correct!</div>
        <p id="round-message" class="text-lg text-purple-300">You're on fire! Keep it up!</p>
      </div>
      <div class="text-center mb-4">
        <div class="text-sm text-purple-200" id="song-info"></div>
      </div>
      
      <!-- Current Round Scoreboard -->
      <div class="mb-6">
        <h3 class="text-xl font-bold mb-3 text-purple-300">Current Standings</h3>
        <div class="bg-black bg-opacity-50 rounded-xl p-4">
          <table class="w-full text-white">
            <thead>
              <tr class="border-b border-purple-800">
                <th class="py-2 text-left">Player</th>
                <th class="py-2 text-right">Score</th>
                <th class="py-2 text-right">This Round</th>
              </tr>
            </thead>
            <tbody id="round-score-table">
              <!-- Player scores will be added dynamically -->
            </tbody>
          </table>
        </div>
      </div>
      
      <div class="flex justify-center">
        <button id="next-round-btn" class="bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-500 hover:to-indigo-500 text-white font-bold py-3 px-8 rounded-lg transform transition hover:scale-105">
          Next Round
        </button>
      </div>
    </div>
  </div>

  <!-- Results Modal (Hidden by default) -->
  <div id="results-modal" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 hidden overflow-y-auto py-10">
    <div id="results-content" class="bg-gradient-to-b from-gray-900 to-purple-900 rounded-2xl p-8 max-w-2xl w-full mx-4 relative shadow-2xl transform transition-all duration-500 scale-95 opacity-0 border-2 border-purple-500/30">
      <!-- Trophy icon at the top -->
      <div class="absolute -top-16 left-1/2 transform -translate-x-1/2 bg-gradient-to-r from-yellow-400 to-yellow-200 rounded-full p-4 shadow-xl">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-14 w-14 text-purple-900" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
        </svg>
      </div>
      
      <h2 class="text-4xl font-extrabold mb-4 text-center text-white mt-6 animate-pulseGrow">Game Over!</h2>
      
      <div class="mb-4 text-center">
        <div class="text-6xl font-bold text-yellow-400 mb-2 animate-pulseGrow" id="final-score">0/10</div>
        <p class="text-xl font-bold text-center text-purple-300 my-4 animate-pulseGrow" id="score-message">Great game!</p>
      </div>
      
      <!-- Animated Stars background -->
      <div class="absolute inset-0 overflow-hidden pointer-events-none z-0">
        <div class="stars-container"></div>
      </div>
      
      <!-- Game Statistics -->
      <div id="game-stats" class="mb-6">
        <!-- Stats will be added dynamically -->
      </div>
      
      <!-- Final Scoreboard -->
      <div id="final-scoreboard" class="mb-8">
        <h3 class="text-xl font-bold mb-3 text-purple-300">Final Scoreboard</h3>
        <div class="bg-black bg-opacity-60 rounded-xl p-4 border border-purple-800/30">
          <table class="w-full text-white">
            <thead>
              <tr class="border-b border-purple-800">
                <th class="py-2 text-left">Player</th>
                <th class="py-2 text-center">Score</th>
                <th class="py-2 text-right">Accuracy</th>
              </tr>
            </thead>
            <tbody id="score-table-body" class="text-lg">
              <!-- Scores will be added dynamically -->
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Tracks Summary -->
      <div id="played-tracks-summary" class="mb-8">
        <!-- Recent tracks will be added dynamically -->
      </div>
      
      <div class="flex flex-col sm:flex-row gap-4 justify-center mt-6">
        <button id="replay-btn" class="bg-gradient-to-r from-purple-700 to-purple-600 hover:from-purple-600 hover:to-purple-500 text-white font-bold py-3 px-8 rounded-lg transform transition hover:scale-105 shadow-lg animate-fadeInUp" style="animation-delay: 0.6s">
          <div class="flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
            </svg>
            Play Again
          </div>
        </button>
        <button id="menu-btn" class="bg-gradient-to-r from-indigo-700 to-indigo-600 hover:from-indigo-600 hover:to-indigo-500 text-white font-bold py-3 px-8 rounded-lg transform transition hover:scale-105 shadow-lg animate-fadeInUp" style="animation-delay: 0.7s">
          <div class="flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
            </svg>
            Return to Main Menu
          </div>
        </button>
      </div>
    </div>
  </div>

  <!-- Game Logic -->
  <script type="module">
    import { getAllGenres, getRandomTrackFromGenre, resetPlayedTracks } from "./src/js/music.js";
    
    // Game variables
    let score = 0;
    let currentRound = 0;
    let totalRounds = 10;
    let timeLimit = 15; // Seconds
    let lives = 3; // Default lives for Marathon mode
    let remainingLives = 3;
    let timer = null;
    let correctAnswer = '';
    let currentTrack = null;
    let gameMode = '';
    let players = [];
    let settings = {
      categories: [],
      questionType: 'mixed',
      previewLength: 10,
      lives: '3'
    };
    
    // DOM elements
    const musicPlayer = document.getElementById('music-player');
    const timerBar = document.getElementById('timer-bar');
    const playIcon = document.getElementById('play-icon');
    const pauseIcon = document.getElementById('pause-icon');
    const answerButtons = document.querySelectorAll('.answer-btn');
    
    // Initialize game
    document.addEventListener('DOMContentLoaded', async () => {
      // Get game mode and settings
      gameMode = new URLSearchParams(window.location.search).get('mode') || 'solo';
      loadGameSettings();
      
      // Reset track history when starting a new game
      resetPlayedTracks();
      
      // Set up UI based on game mode
      setupGameMode();
      
      // Simulate loading
      simulateLoading().then(() => {
        // Start the first round
        startNewRound();
        
        // Set up event listeners
        setupEventListeners();
      });
    });
    
    // Load settings from localStorage
    function loadGameSettings() {
      const savedSettings = localStorage.getItem('riffleGameSettings');
      if (savedSettings) {
        const parsed = JSON.parse(savedSettings);
        settings = {
          ...settings,
          ...parsed
        };
        
        if (settings.rounds && settings.rounds !== 'unlimited') {
          totalRounds = parseInt(settings.rounds);
          document.getElementById('max-score').textContent = totalRounds;
        }
        
        if (settings.timeLimit) {
          timeLimit = settings.timeLimit;
        }
        
        // Load lives setting for Marathon mode
        if (settings.lives && gameMode === 'solo') {
          lives = settings.lives === 'unlimited' ? Infinity : parseInt(settings.lives);
          remainingLives = lives;
        }
        
        // Load avatar if available
        const avatar = settings.avatar || localStorage.getItem('selectedAvatar') || 'avatar1';
        document.getElementById('player-avatar').src = `src/img/avatars/${avatar}.png`;
        
        document.getElementById('game-mode-title').textContent = {
          'solo': 'Marathon Mode',
          'coop': 'Cooperative Mode',
          'versus': 'Solo VS Mode',
          'team': 'Team VS Mode',
          'chaos': 'Chaos Mode',
          'custom': 'Custom Mode'
        }[gameMode] || 'Riffle';
      }
    }
    
    // Setup game mode specific UI
    function setupGameMode() {
      // Show/hide UI elements based on game mode
      if (gameMode === 'solo') { // Marathon mode
        document.getElementById('timer-container').classList.add('hidden');
        document.getElementById('players-container').classList.add('hidden');
        
        // For marathon mode, if rounds is unlimited, hide round info
        if (settings.rounds === 'unlimited') {
          document.getElementById('round-info').classList.add('hidden');
        }
        
        // Show lives for Marathon mode
        const livesDisplay = document.getElementById('lives-display');
        const livesCount = document.getElementById('lives-count');
        
        if (livesDisplay && livesCount) {
          livesDisplay.classList.remove('hidden');
          
          // Set the appropriate number of lives
          if (lives === Infinity) {
            livesCount.textContent = 'âˆž';
          } else {
            livesCount.textContent = remainingLives;
          }
        }
      } else {
        // VS modes show timer
        document.getElementById('timer-container').classList.remove('hidden');
        // Team/Versus/Coop modes show players
        if (['versus', 'team', 'coop'].includes(gameMode)) {
          document.getElementById('players-container').classList.remove('hidden');
          // Generate mock players for demo
          generateMockPlayers();
        }
      }
    }
    
    // Generate mock players for multiplayer demo
    function generateMockPlayers() {
      const playerNames = ['Sen', 'Ahmet', 'Zeynep', 'Burak'];
      const playerColors = ['purple-500', 'blue-500', 'green-500', 'yellow-500'];
      const playersList = document.getElementById('players-list');
      
      playersList.innerHTML = '';
      
      playerNames.forEach((name, i) => {
        // For the player (i === 0), use their selected avatar
        const avatar = i === 0 ? 
          (settings.avatar || localStorage.getItem('selectedAvatar') || 'avatar1') : 
          `avatar${Math.floor(Math.random() * 4) + 1}`;
        
        players.push({
          name,
          score: 0,
          color: playerColors[i],
          avatar: avatar
        });
        
        const playerCard = document.createElement('div');
        playerCard.className = `bg-gray-800 bg-opacity-70 rounded-lg p-3 text-center border-l-4 border-${playerColors[i]}`;
        playerCard.innerHTML = `
          <div class="mb-2 flex justify-center">
            <div class="h-10 w-10 rounded-full bg-gradient-to-br from-${playerColors[i]} to-indigo-600 p-1">
              <img src="src/img/avatars/${avatar}.png" alt="${name}'s Avatar" class="rounded-full">
            </div>
          </div>
          <div class="font-bold ${i === 0 ? 'text-white' : 'text-gray-300'}">${name}</div>
          <div class="text-2xl font-bold text-${playerColors[i]}">0</div>
        `;
        playersList.appendChild(playerCard);
      });
    }
    
    // Simulate loading
    function simulateLoading() {
      return new Promise(resolve => {
        const loadingProgress = document.getElementById('loading-progress');
        const loadingText = document.getElementById('loading-text');
        const loadingScreen = document.getElementById('loading-screen');
        
        let progress = 0;
        const interval = setInterval(() => {
          progress += Math.random() * 15;
          if (progress > 100) progress = 100;
          
          loadingProgress.style.width = `${progress}%`;
          
          if (progress < 30) {
            loadingText.textContent = 'Loading music tracks...';
          } else if (progress < 60) {
            loadingText.textContent = 'Preparing categories...';
          } else if (progress < 90) {
            loadingText.textContent = 'Almost ready...';
          } else {
            loadingText.textContent = 'Starting!';
          }
          
          if (progress === 100) {
            clearInterval(interval);
            setTimeout(() => {
              loadingScreen.classList.add('opacity-0');
              loadingScreen.style.transition = 'opacity 0.5s ease-out';
              setTimeout(() => {
                loadingScreen.classList.add('hidden');
                resolve();
              }, 500);
            }, 500);
          }
        }, 200);
      });
    }
    
    // Start a new round
    async function startNewRound() {
      // Check if we've reached the round limit
      if (settings.rounds !== 'unlimited' && currentRound >= totalRounds) {
        // Game is complete, show the final results
        showGameOverScreen();
        return;
      }
      
      currentRound++;
      
      // Update round info
      if (settings.rounds !== 'unlimited') {
        document.getElementById('round-info').textContent = `Question ${currentRound}/${totalRounds}`;
      } else {
        document.getElementById('round-info').textContent = `Question ${currentRound}`;
      }
      
      // Reset UI
      resetUI();
      
      try {
        // Get random track
        let track;
        if (settings.categories && settings.categories.length > 0) {
          // Choose random category from selected ones
          const categoryId = settings.categories[Math.floor(Math.random() * settings.categories.length)];
          track = await getRandomTrackFromGenre(categoryId);
        } else {
          // Default to random genre
          track = await getRandomTrackFromGenre('rock_80s');
        }
        
        currentTrack = track;
        
        // Set audio source
        musicPlayer.src = track.preview;
        musicPlayer.volume = 0.8;
        
        // Prepare question based on settings
        let questionType = settings.questionType;
        if (questionType === 'mixed') {
          questionType = Math.random() > 0.5 ? 'song' : 'artist';
        }
        
        // Set question text and correct answer
        const questionText = document.getElementById('question-text');
        const genreInfo = document.getElementById('genre-info');
        
        if (questionType === 'song') {
          questionText.textContent = 'Which song is this?';
          correctAnswer = track.title;
        } else if (questionType === 'artist') {
          questionText.textContent = 'Which artist/band performs this track?';
          correctAnswer = track.artist;
        } else if (questionType === 'guitarist') {
          questionText.textContent = 'Who is the guitarist for this track?';
          correctAnswer = track.guitarist || track.artist; // Fallback if guitarist info not available
        }
        
        genreInfo.textContent = track.genreName || 'Rock/Metal';
        
        // Generate answer options
        generateAnswerOptions();
        
        // Play the music preview after a short delay
        setTimeout(() => {
          playMusic();
          
          // Start timer for VS modes
          if (gameMode !== 'solo') {
            startTimer();
          }
        }, 1000);
        
      } catch (error) {
        console.error('Error loading track:', error);
        alert('An error occurred while loading the track. Please try again.');
      }
    }
    
    // Generate answer options
    function generateAnswerOptions() {
      // Enhanced fake options organized by era and genre
      const enhancedOptions = {
        'song': {
          '60s': ['House Of The Rising Sun', 'Purple Haze', 'Born To Be Wild', 'Light My Fire', 'Fortunate Son', 'Good Vibrations', 'Satisfaction', 'Gimme Shelter', 'White Rabbit', 'All Along The Watchtower'],
          '70s': ['Stairway To Heaven', 'Hotel California', 'Smoke On The Water', 'Bohemian Rhapsody', 'Black Dog', 'Paranoid', 'Another Brick In The Wall', 'Dream On', 'Layla', 'Free Bird'],
          '80s': ['Sweet Child O\' Mine', 'Enter Sandman', 'Back in Black', 'Crazy Train', 'Run To The Hills', 'Breaking The Law', 'You Give Love A Bad Name', 'Welcome To The Jungle', 'Master of Puppets', 'Jump'],
          '90s': ['Nothing Else Matters', 'Smells Like Teen Spirit', 'Black Hole Sun', 'Enter Sandman', 'One', 'Sober', 'Alive', 'Jeremy', 'Zombie', 'Basket Case'],
          '00s': ['Chop Suey!', 'In The End', 'Toxicity', 'Seven Nation Army', 'Boulevard of Broken Dreams', 'Numb', 'The Pretender', 'Mr. Brightside', 'Last Resort', 'Diary of Jane']
        },
        'artist': {
          '60s': ['The Doors', 'Jimi Hendrix', 'The Beatles', 'The Rolling Stones', 'Jefferson Airplane', 'Steppenwolf', 'Cream', 'The Who', 'The Animals', 'Creedence Clearwater Revival'],
          '70s': ['Led Zeppelin', 'Black Sabbath', 'Deep Purple', 'Queen', 'Pink Floyd', 'AC/DC', 'Aerosmith', 'Lynyrd Skynyrd', 'The Eagles', 'Kiss'],
          '80s': ['Metallica', 'Guns N\' Roses', 'Iron Maiden', 'Judas Priest', 'Motley Crue', 'Van Halen', 'Bon Jovi', 'Def Leppard', 'Megadeth', 'Scorpions'],
          '90s': ['Nirvana', 'Pearl Jam', 'Soundgarden', 'Alice In Chains', 'Rage Against The Machine', 'Tool', 'Red Hot Chili Peppers', 'Radiohead', 'The Cranberries', 'Green Day'],
          '00s': ['System Of A Down', 'Linkin Park', 'Disturbed', 'The White Stripes', 'Slipknot', 'Evanescence', 'Foo Fighters', 'The Killers', 'Papa Roach', 'Breaking Benjamin']
        },
        'guitarist': {
          '60s': ['Jimi Hendrix', 'Keith Richards', 'Eric Clapton', 'Pete Townshend', 'Jimmy Page', 'Jeff Beck', 'David Gilmour', 'Jorma Kaukonen', 'John Fogerty', 'George Harrison'],
          '70s': ['Jimmy Page', 'Tony Iommi', 'Ritchie Blackmore', 'Brian May', 'David Gilmour', 'Angus Young', 'Joe Perry', 'Allen Collins', 'Don Felder', 'Ace Frehley'],
          '80s': ['Kirk Hammett', 'Slash', 'Dave Murray', 'K.K. Downing', 'Mick Mars', 'Eddie Van Halen', 'Richie Sambora', 'Phil Collen', 'Marty Friedman', 'Rudolf Schenker'],
          '90s': ['Kurt Cobain', 'Mike McCready', 'Kim Thayil', 'Jerry Cantrell', 'Tom Morello', 'Adam Jones', 'John Frusciante', 'Jonny Greenwood', 'Billie Joe Armstrong', 'Noel Gallagher'],
          '00s': ['Daron Malakian', 'Brad Delson', 'Dan Donegan', 'Jack White', 'Jim Root', 'Ben Moody', 'Dave Grohl', 'Matthew Bellamy', 'Zacky Vengeance', 'Mark Tremonti']
        },
        'turkish': {
          'artist': ['BarÄ±ÅŸ ManÃ§o', 'Erkin Koray', 'Cem Karaca', 'Murat Ses', 'Mor ve Ã–tesi', 'Duman', 'Pentagram/Mezarkabul', 'Hayko Cepkin', 'Kurban', 'Åžebnem Ferah'],
          'song': ['DÃ¶nence', 'Yine YalnÄ±zÄ±m', 'Resimdeki GÃ¶zyaÅŸlarÄ±', 'Ä°ÅŸte Hendek Ä°ÅŸte Deve', 'Bir Derdim Var', 'Senden Daha GÃ¼zel', 'Lions In A Cage', 'Bertaraf Et', 'Yirmi', 'Can KÄ±rÄ±klarÄ±']
        }
      };
      
      const questionType = settings.questionType === 'mixed' ? 
        (correctAnswer === currentTrack.title ? 'song' : 'artist') : settings.questionType;
      
      // Determine the era and genre based on current track
      let era = '80s'; // Default era if we can't determine
      let genre = 'rock';
      
      // Try to determine era from track genre
      if (currentTrack.genreName) {
        const genreLower = currentTrack.genreName.toLowerCase();
        if (genreLower.includes('60')) era = '60s';
        else if (genreLower.includes('70')) era = '70s';
        else if (genreLower.includes('80')) era = '80s';
        else if (genreLower.includes('90')) era = '90s';
        else if (genreLower.includes('00') || genreLower.includes('2000')) era = '00s';
        
        // Check if it's Turkish music
        if (genreLower.includes('turkish') || genreLower.includes('anatolia')) {
          genre = 'turkish';
        }
      }
      
      let options = [correctAnswer];
      
      // Add appropriate fake options based on era and genre
      while (options.length < 4) {
        let optionPool;
        
        if (genre === 'turkish' && enhancedOptions.turkish[questionType]) {
          optionPool = enhancedOptions.turkish[questionType];
        } else if (enhancedOptions[questionType] && enhancedOptions[questionType][era]) {
          optionPool = enhancedOptions[questionType][era];
        } else {
          // Fallback to any era if specific era not available
          const allEras = Object.values(enhancedOptions[questionType] || {}).flat();
          optionPool = allEras.length > 0 ? allEras : enhancedOptions.artist['80s']; // Default fallback
        }
        
        const randomOption = optionPool[Math.floor(Math.random() * optionPool.length)];
        
        if (!options.includes(randomOption)) {
          options.push(randomOption);
        }
      }
      
      // Shuffle options
      options = shuffleArray(options);
      
      // Set button texts
      answerButtons.forEach((btn, i) => {
        btn.textContent = options[i];
        btn.dataset.answer = options[i];
      });
    }
    
    // Reset UI for new round
    function resetUI() {
      // Reset timer
      if (timer) clearInterval(timer);
      timerBar.style.width = '100%';
      
      // Reset buttons
      answerButtons.forEach(btn => {
        btn.classList.remove('correct', 'wrong', 'selected');
        btn.disabled = false;
      });
      
      // Reset music player
      musicPlayer.pause();
      musicPlayer.currentTime = 0;
      
      // Reset icons
      playIcon.classList.remove('hidden');
      pauseIcon.classList.add('hidden');
      
      // Create visualizer
      createVisualizer();
    }
    
    // Start timer for VS modes
    function startTimer() {
      let timeLeft = timeLimit;
      timerBar.style.width = '100%';
      
      timer = setInterval(() => {
        timeLeft -= 0.1;
        const percentage = (timeLeft / timeLimit) * 100;
        timerBar.style.width = `${percentage}%`;
        
        if (timeLeft <= 0) {
          clearInterval(timer);
          handleTimeout();
        }
      }, 100);
    }
    
    // Handle timeout (no answer selected)
    function handleTimeout() {
      musicPlayer.pause();
      
      // Highlight correct answer
      answerButtons.forEach(btn => {
        btn.disabled = true;
        if (btn.dataset.answer === correctAnswer) {
          btn.classList.add('correct');
        }
      });
      
      // Wait a moment and continue
      setTimeout(checkGameProgress, 2000);
    }
    
    // Play music preview
    function playMusic() {
      musicPlayer.play();
      playIcon.classList.add('hidden');
      pauseIcon.classList.remove('hidden');
      
      // Stop after preview length
      setTimeout(() => {
        if (!musicPlayer.paused) {
          musicPlayer.pause();
          playIcon.classList.remove('hidden');
          pauseIcon.classList.add('hidden');
        }
      }, settings.previewLength * 1000);
    }
    
    // Toggle play/pause
    function togglePlayPause() {
      if (musicPlayer.paused) {
        musicPlayer.play();
        playIcon.classList.add('hidden');
        pauseIcon.classList.remove('hidden');
      } else {
        musicPlayer.pause();
        playIcon.classList.remove('hidden');
        pauseIcon.classList.add('hidden');
      }
    }
    
    // Create audio visualizer
    function createVisualizer() {
      const visualizer = document.getElementById('visualizer');
      visualizer.innerHTML = '';
      
      const barCount = 24;
      
      for (let i = 0; i < barCount; i++) {
        const bar = document.createElement('div');
        bar.className = 'bg-purple-500 opacity-70 mx-0.5';
        bar.style.width = '4px';
        bar.style.height = `${Math.random() * 40 + 10}px`;
        bar.style.transform = `rotate(${(i * (360 / barCount))}deg) translateY(-80px)`;
        visualizer.appendChild(bar);
      }
    }
    
    // Animate visualizer with mock data
    function animateVisualizer() {
      const bars = document.querySelectorAll('#visualizer div');
      
      bars.forEach(bar => {
        if (!musicPlayer.paused) {
          const height = Math.random() * 40 + 10;
          bar.style.height = `${height}px`;
          bar.style.opacity = 0.5 + (height / 100);
        }
      });
      
      requestAnimationFrame(animateVisualizer);
    }
    
    // Handle answer selection
    function handleAnswerClick(e) {
      const selectedButton = e.currentTarget;
      const selectedAnswer = selectedButton.dataset.answer;
      
      // Stop timer
      if (timer) clearInterval(timer);
      
      // Mark button as selected
      selectedButton.classList.add('selected');
      
      // Disable all buttons
      answerButtons.forEach(btn => {
        btn.disabled = true;
      });
      
      // Check if answer is correct
      const isCorrect = selectedAnswer === correctAnswer;
      
      if (isCorrect) {
        selectedButton.classList.add('correct');
        score++;
        document.getElementById('current-score').textContent = score;
        
        // Create confetti effect for correct answer
        createConfetti();
      } else {
        selectedButton.classList.add('wrong');
        
        // Show correct answer
        answerButtons.forEach(btn => {
          if (btn.dataset.answer === correctAnswer) {
            btn.classList.add('correct');
          }
        });
        
        // Reduce lives in Marathon mode
        if (gameMode === 'solo' && lives !== Infinity) {
          remainingLives--;
          document.getElementById('lives-count').textContent = remainingLives;
          
          // Visual effect for losing a life
          const livesDisplay = document.getElementById('lives-display');
          livesDisplay.classList.add('animate-pulse');
          setTimeout(() => {
            livesDisplay.classList.remove('animate-pulse');
          }, 1000);
        }
      }
      
      // Stop music
      musicPlayer.pause();
      playIcon.classList.remove('hidden');
      pauseIcon.classList.add('hidden');
      
      // Update player score in multiplayer
      if (['versus', 'team', 'coop'].includes(gameMode)) {
        updatePlayerScore(0, isCorrect ? 1 : 0); // Always update player 0 (user) for demo
      }
      
      // Wait a moment and continue
      setTimeout(checkGameProgress, 2000);
    }
    
    // Update player score in UI
    function updatePlayerScore(playerIndex, points) {
      if (players[playerIndex]) {
        players[playerIndex].score += points;
        
        const playerElements = document.querySelectorAll('#players-list > div');
        if (playerElements[playerIndex]) {
          const scoreElement = playerElements[playerIndex].querySelector('div:last-child');
          if (scoreElement) {
            scoreElement.textContent = players[playerIndex].score;
          }
        }
      }
    }
    
    // Check if game should continue or end
    function checkGameProgress() {
      // For Marathon mode, check if player ran out of lives
      if (gameMode === 'solo' && lives !== Infinity && remainingLives <= 0) {
        // Game over due to running out of lives
        showRoundCompletionScreen(true); // true indicates game over
        return;
      }
      
      // Show the round completion screen regardless of whether the game continues or ends
      showRoundCompletionScreen();
    }
    
    // Show the round completion screen with current standings
    function showRoundCompletionScreen(isGameOver = false) {
      const roundCompletion = document.getElementById('round-completion');
      const roundResult = document.getElementById('round-result');
      const roundMessage = document.getElementById('round-message');
      const scoreTable = document.getElementById('round-score-table');
      const nextRoundBtn = document.getElementById('next-round-btn');
      const albumCoverDisplay = document.getElementById('album-cover-display');
      const songInfo = document.getElementById('song-info');
      
      // Display album cover and song info if available
      if (currentTrack && currentTrack.album && currentTrack.album.cover_medium) {
        albumCoverDisplay.src = currentTrack.album.cover_medium;
        songInfo.textContent = `${currentTrack.title} by ${currentTrack.artist}`;
      } else if (currentTrack) {
        // Fallback if no album cover
        albumCoverDisplay.src = "https://via.placeholder.com/200/6D28D9/FFFFFF?text=Riffle";
        songInfo.textContent = `${currentTrack.title} by ${currentTrack.artist}`;
      }
      
      // Set result message based on the last answer
      const lastAnswerCorrect = document.querySelector('.answer-btn.correct.selected') !== null;
      
      if (lastAnswerCorrect) {
        roundResult.textContent = 'Correct!';
        
        // Different messages based on performance
        if (score / currentRound > 0.8) {
          roundMessage.textContent = 'You\'re on fire! Keep it up!';
        } else if (score / currentRound > 0.5) {
          roundMessage.textContent = 'Well done! You\'re doing great!';
        } else {
          roundMessage.textContent = 'Correct! Keep improving!';
        }
        
        roundResult.classList.remove('text-red-400');
        roundResult.classList.add('text-yellow-400');
      } else {
        roundResult.textContent = 'Wrong Answer!';
        roundMessage.textContent = 'Better luck on the next one!';
        roundResult.classList.remove('text-yellow-400');
        roundResult.classList.add('text-red-400');
      }
      
      // Update the score table
      scoreTable.innerHTML = '';
      
      if (['versus', 'team', 'coop'].includes(gameMode)) {
        // Show all players in multiplayer mode
        players.forEach(player => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="py-2">
              <div class="flex items-center">
                <div class="h-6 w-6 rounded-full bg-gradient-to-br from-${player.color} to-indigo-600 p-0.5 mr-2">
                  <img src="src/img/avatars/${player.avatar}.png" alt="${player.name}'s Avatar" class="rounded-full">
                </div>
                ${player.name}
              </div>
            </td>
            <td class="py-2 text-right">${player.score}</td>
            <td class="py-2 text-right">${player === players[0] && lastAnswerCorrect ? '+1' : '+0'}</td>
          `;
          scoreTable.appendChild(row);
        });
      } else {
        // Solo mode - just show player score
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="py-2">You</td>
          <td class="py-2 text-right">${score}</td>
          <td class="py-2 text-right">${lastAnswerCorrect ? '+1' : '+0'}</td>
        `;
        scoreTable.appendChild(row);
      }
      
      // Update button text based on whether there are more rounds or game is over
      if (isGameOver || (settings.rounds !== 'unlimited' && currentRound >= totalRounds)) {
        nextRoundBtn.textContent = 'See Final Results';
        
        if (isGameOver && gameMode === 'solo' && lives !== Infinity) {
          roundResult.textContent = 'Game Over!';
          roundMessage.textContent = 'You ran out of lives!';
          roundResult.classList.remove('text-yellow-400');
          roundResult.classList.add('text-red-400');
        }
      } else {
        nextRoundBtn.textContent = 'Next Round';
      }
      
      // Handle button click
      nextRoundBtn.onclick = function() {
        roundCompletion.classList.add('hidden');
        
        // Check if game should end or continue
        if (isGameOver || (settings.rounds !== 'unlimited' && currentRound >= totalRounds)) {
          endGame();
        } else {
          startNewRound();
        }
      };
      
      // Show the round completion screen with a slight delay
      setTimeout(() => {
        roundCompletion.classList.remove('hidden');
      }, 500);
    }
    
    // End the game and show results
    function endGame() {
      const finalScore = document.getElementById('final-score');
      const scoreMessage = document.getElementById('score-message');
      const resultsModal = document.getElementById('results-modal');
      const resultsContent = document.getElementById('results-content');
      const scoreTableBody = document.getElementById('score-table-body');
      const gameStats = document.getElementById('game-stats');
      
      // Show final score
      finalScore.textContent = `${score}/${totalRounds}`;
      
      // Generate score message
      const percentage = (score / totalRounds) * 100;
      if (percentage >= 90) {
        scoreMessage.textContent = 'Amazing! You are a true music genius!';
        scoreMessage.className = 'text-2xl font-bold text-center text-yellow-400 my-4 animate-pulseGrow';
        generateStars(25); // More stars for better performance
      } else if (percentage >= 70) {
        scoreMessage.textContent = 'Great! Your music knowledge is impressive!';
        scoreMessage.className = 'text-2xl font-bold text-center text-green-400 my-4 animate-pulseGrow';
        generateStars(15);
      } else if (percentage >= 50) {
        scoreMessage.textContent = 'Good! You could use a bit more practice.';
        scoreMessage.className = 'text-2xl font-bold text-center text-blue-400 my-4 animate-pulseGrow';
        generateStars(8);
      } else if (percentage >= 30) {
        scoreMessage.textContent = 'Not bad. You should listen to more music!';
        scoreMessage.className = 'text-2xl font-bold text-center text-purple-400 my-4 animate-pulseGrow';
        generateStars(4);
      } else {
        scoreMessage.textContent = 'Thanks for playing anyway!';
        scoreMessage.className = 'text-2xl font-bold text-center text-gray-400 my-4 animate-pulseGrow';
        generateStars(2);
      }
      
      // Update game statistics
      const averageResponseTime = responseTimeHistory.length > 0 
        ? responseTimeHistory.reduce((a, b) => a + b, 0) / responseTimeHistory.length / 1000 
        : 0;
      
      // Prepare the stats HTML
      let statsHTML = `
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 my-6">
          <div class="bg-gray-800 rounded-lg p-4 text-center animate-fadeInUp" style="animation-delay: 0.1s">
            <p class="text-gray-400 text-sm">Rounds Played</p>
            <p class="text-2xl font-bold">${currentRound}</p>
          </div>
          <div class="bg-gray-800 rounded-lg p-4 text-center animate-fadeInUp" style="animation-delay: 0.2s">
            <p class="text-gray-400 text-sm">Accuracy</p>
            <p class="text-2xl font-bold">${Math.round(percentage)}%</p>
          </div>`;
          
      // Add lives stat for Marathon mode
      if (gameMode === 'solo' && lives !== undefined) {
        statsHTML += `
          <div class="bg-gray-800 rounded-lg p-4 text-center animate-fadeInUp" style="animation-delay: 0.3s">
            <p class="text-gray-400 text-sm">Lives Left</p>
            <p class="text-2xl font-bold">${lives === Infinity ? 'âˆž' : remainingLives}</p>
          </div>`;
      } else {
        statsHTML += `
          <div class="bg-gray-800 rounded-lg p-4 text-center animate-fadeInUp" style="animation-delay: 0.3s">
            <p class="text-gray-400 text-sm">Avg Response</p>
            <p class="text-2xl font-bold">${averageResponseTime.toFixed(1)}s</p>
          </div>`;
      }
      
      statsHTML += `
          <div class="bg-gray-800 rounded-lg p-4 text-center animate-fadeInUp" style="animation-delay: 0.4s">
            <p class="text-gray-400 text-sm">Game Mode</p>
            <p class="text-2xl font-bold">${gameMode.charAt(0).toUpperCase() + gameMode.slice(1)}</p>
          </div>
        </div>
      `;
      
      // Set the HTML
      gameStats.innerHTML = statsHTML;
      
      // Generate scoreboard for multiplayer
      scoreTableBody.innerHTML = '';
      
      if (['versus', 'team', 'coop'].includes(gameMode)) {
        // Sort players by score
        const sortedPlayers = [...players].sort((a, b) => b.score - a.score);
        
        sortedPlayers.forEach((player, i) => {
          // Calculate accuracy percentage
          const accuracy = Math.round((player.score / totalRounds) * 100);
          
          const row = document.createElement('tr');
          row.className = i === 0 ? 'font-bold animate-fadeInUp' : 'animate-fadeInUp';
          row.style.animationDelay = `${0.1 + (i * 0.1)}s`;
          row.innerHTML = `
            <td class="py-3">
              <div class="flex items-center">
                ${i === 0 ? '<span class="text-yellow-400 mr-2">ðŸ‘‘</span>' : (i === 1 ? '<span class="text-gray-300 mr-2">ðŸ¥ˆ</span>' : (i === 2 ? '<span class="text-amber-700 mr-2">ðŸ¥‰</span>' : ''))}
                <div class="h-7 w-7 rounded-full bg-gradient-to-br from-${player.color} to-indigo-600 p-0.5 mr-2">
                  <img src="src/img/avatars/${player.avatar}.png" alt="${player.name}'s Avatar" class="rounded-full">
                </div>
                ${player.name}
              </div>
            </td>
            <td class="py-3 text-center text-${player.color}-400">${player.score}</td>
            <td class="py-3 text-right">
              <span class="inline-block bg-gray-800 rounded-full px-2 py-1 text-sm">
                ${accuracy}%
              </span>
            </td>
          `;
          scoreTableBody.appendChild(row);
        });
      } else {
        // Solo mode - just show player's score
        const accuracy = Math.round((score / totalRounds) * 100);
        
        const row = document.createElement('tr');
        row.className = 'font-bold animate-fadeInUp';
        row.innerHTML = `
          <td class="py-3">
            <div class="flex items-center">
              <span class="text-yellow-400 mr-2">ðŸ‘‘</span>
              You
            </div>
          </td>
          <td class="py-3 text-center text-purple-400">${score}</td>
          <td class="py-3 text-right">
            <span class="inline-block bg-gray-800 rounded-full px-2 py-1 text-sm">
              ${accuracy}%
            </span>
          </td>
        `;
        scoreTableBody.appendChild(row);
        
        // Add a tracks list of what was played
        const playedSummary = document.getElementById('played-tracks-summary');
        if (playedSummary) {
          playedSummary.innerHTML = '';
          
          // Get the last 5 tracks played
          const recentTracks = playedTracks.slice(-5);
          
          if (recentTracks.length > 0) {
            const tracksList = document.createElement('div');
            tracksList.className = 'mt-6';
            tracksList.innerHTML = `
              <h3 class="text-gray-300 text-sm uppercase tracking-wide mb-2">Recent Tracks</h3>
              <ul class="bg-gray-800 bg-opacity-50 rounded-lg overflow-hidden">
                ${recentTracks.map((track, i) => `
                  <li class="px-4 py-2 border-b border-gray-700 last:border-0 animate-fadeInUp" style="animation-delay: ${0.3 + (i * 0.1)}s">
                    <div class="flex items-center">
                      <span class="text-gray-400 text-sm mr-2">${i + 1}.</span>
                      <div>
                        <p class="font-medium">${track.artist_name} - ${track.title}</p>
                        <p class="text-sm text-gray-400">${track.album ? track.album.title : 'Unknown Album'}</p>
                      </div>
                    </div>
                  </li>
                `).join('')}
              </ul>
            `;
            playedSummary.appendChild(tracksList);
          }
        }
      }
      
      // Create a small delay to show the modal with animation
      resultsModal.classList.remove('hidden');
      
      // Trigger confetti when showing results
      createConfetti();
      
      // Fade in animation
      setTimeout(() => {
        resultsModal.classList.add('show-modal');
        
        // Apply animation to the stars
        const stars = document.querySelectorAll('.star');
        stars.forEach(star => {
          star.style.animation = `rotateStar ${Math.random() * 5 + 5}s infinite linear`;
        });
      }, 100);
    }
    
    // Generate stars for the final screen
    function generateStars(count) {
      const starsContainer = document.querySelector('.stars-container');
      starsContainer.innerHTML = ''; // Clear any existing stars
      
      for (let i = 0; i < count; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        
        // Randomize the star appearance
        const size = Math.random() * 20 + 10; // 10-30px
        const posX = Math.random() * 100; // Percentage position
        const posY = Math.random() * 100; // Percentage position
        const delay = Math.random() * 2; // 0-2s delay
        const duration = Math.random() * 3 + 2; // 2-5s animation duration
        
        // Apply the random styles
        star.style.width = `${size}px`;
        star.style.height = `${size}px`;
        star.style.left = `${posX}%`;
        star.style.top = `${posY}%`;
        star.style.animationDelay = `${delay}s`;
        star.style.animationDuration = `${duration}s`;
        
        starsContainer.appendChild(star);
      }
    }
    
    // Create confetti effect
    function createConfetti() {
      const confettiCount = 100;
      const container = document.body;
      const colors = ['#f00', '#0f0', '#00f', '#ff0', '#0ff', '#f0f'];
      
      for (let i = 0; i < confettiCount; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.left = `${Math.random() * 100}vw`;
        confetti.style.top = '50vh';
        confetti.style.animation = `fadeAndMove ${Math.random() * 3 + 1}s forwards`;
        confetti.style.opacity = Math.random();
        confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
        
        container.appendChild(confetti);
        
        // Remove after animation
        setTimeout(() => {
          confetti.remove();
        }, 3000);
      }
    }
    
    // Set up event listeners
    function setupEventListeners() {
      // Play/pause button
      document.querySelector('.pulse-animation').addEventListener('click', togglePlayPause);
      
      // Answer buttons
      answerButtons.forEach(btn => {
        btn.addEventListener('click', handleAnswerClick);
      });
      
      // Results modal buttons
      document.getElementById('replay-btn').addEventListener('click', () => {
        window.location.reload();
      });
      
      document.getElementById('menu-btn').addEventListener('click', () => {
        window.location.href = 'index.html';
      });
      
      // Start visualizer animation
      animateVisualizer();
    }
    
    // Utility: Shuffle array randomly
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }
  </script>
  
  <!-- Script for main menu navigation -->
  <script>
    // Direct event listener for the main menu button
    document.addEventListener('DOMContentLoaded', function() {
      const mainMenuBtn = document.getElementById('mainMenuBtn');
      if (mainMenuBtn) {
        mainMenuBtn.addEventListener('click', function() {
          console.log('Main menu button clicked');
          window.location.href = 'index.html';
        });
        console.log('Main menu button handler initialized');
      } else {
        console.error('Main menu button not found');
      }
    });
  </script>
</body>
</html>
